<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en"><head>
<title>Express csurf middleware</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="og:image" content="https://expressjs.com/images/express-facebook-share.png">
<link rel="icon" type="image/png" href="http://expressjs.com/images/favicon.png">
<link rel="stylesheet" href="Express%20csurf%20middleware_files/style.css">
<link rel="stylesheet" href="Express%20csurf%20middleware_files/dropit.css">
<link rel="stylesheet" href="Express%20csurf%20middleware_files/prism.css">
<link rel="stylesheet" href="Express%20csurf%20middleware_files/font-awesome.css">
<link rel="stylesheet" href="Express%20csurf%20middleware_files/css.css">
<link rel="stylesheet" href="Express%20csurf%20middleware_files/en.css">
<link rel="stylesheet" href="Express%20csurf%20middleware_files/nodeinteractive.css">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script data-cfasync="false" src="Express%20csurf%20middleware_files/jquery.js"></script>
<script data-cfasync="false" src="Express%20csurf%20middleware_files/ismobile.js"></script>
<script data-cfasync="false" src="Express%20csurf%20middleware_files/app.js"></script>
<script data-cfasync="false" src="Express%20csurf%20middleware_files/retina.js"></script>
<script data-cfasync="false" src="Express%20csurf%20middleware_files/dropit.js"></script>
<script data-cfasync="false" src="Express%20csurf%20middleware_files/prism.js"></script>
<link rel="stylesheet" href="Express%20csurf%20middleware_files/docsearch.css">
</head>
<body class="en-doc scroll">
<section class="page content">
<header>
<div id="blm-banner">
Black Lives Matter. <br>
<a id="blm-donate" href="https://support.eji.org/give/153413/#!/donation/checkout">Support the Equal Justice Initiative</a>.
</div>
<div id="mobile-menu">
<div id="nav-button" class="fa fa-bars fa-2x button"></div>
</div>
<section id="logo"><a href="http://expressjs.com/" class="express">Express</a>
</section>
<div id="navbar">
<span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;"><input id="q" placeholder="🔎 search" class="ds-input" autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-label="search input" aria-owns="algolia-autocomplete-listbox-0" style="position: relative; vertical-align: top;" dir="auto"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: Ubuntu; font-size: 14.6667px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: optimizelegibility; text-transform: none;"></pre><span class="ds-dropdown-menu" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;" role="listbox" id="algolia-autocomplete-listbox-0"><div class="ds-dataset-1"></div></span></span>
<ul id="navmenu">
<li><a href="http://expressjs.com/" id="home-menu">Home</a></li>
<li class="">
<ul id="getting-started-menu" class="menu dropit">
<li class="dropit-trigger"><a href="http://expressjs.com/en/starter/installing.html">Getting started</a>
<ul class="dropit-submenu" style="display: none;">
<li>
<a href="http://expressjs.com/en/starter/installing.html">
Installing
</a>
</li>
<li>
<a href="http://expressjs.com/en/starter/hello-world.html">
Hello world
</a>
</li>
<li>
<a href="http://expressjs.com/en/starter/generator.html">
Express generator
</a>
</li>
<li>
<a href="http://expressjs.com/en/starter/basic-routing.html">
Basic routing
</a>
</li>
<li>
<a href="http://expressjs.com/en/starter/static-files.html">
Static files
</a>
</li>
<li>
<a href="http://expressjs.com/en/starter/examples.html">
More examples
</a>
</li>
<li>
<a href="http://expressjs.com/en/starter/faq.html">
FAQ
</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<ul id="guide-menu" class="menu dropit">
<li class="dropit-trigger"><a href="http://expressjs.com/en/guide/routing.html">Guide</a>
<ul class="dropit-submenu" style="display: none;">
<li><a href="http://expressjs.com/en/guide/routing.html">Routing</a>
</li>
<li><a href="http://expressjs.com/en/guide/writing-middleware.html">Writing middleware</a>
</li>
<li><a href="http://expressjs.com/en/guide/using-middleware.html">Using middleware</a>
</li>
<li><a href="http://expressjs.com/en/guide/overriding-express-api.html">Overriding the Express API</a>
</li>
<li><a href="http://expressjs.com/en/guide/using-template-engines.html">Using template engines</a>
</li>
<li><a href="http://expressjs.com/en/guide/error-handling.html">Error handling</a>
</li>
<li><a href="http://expressjs.com/en/guide/debugging.html">Debugging</a>
</li>
<li><a href="http://expressjs.com/en/guide/behind-proxies.html">Express behind proxies</a>
</li>
<li><a href="http://expressjs.com/en/guide/migrating-4.html">Moving to Express 4</a>
</li>
<li><a href="http://expressjs.com/en/guide/migrating-5.html">Moving to Express 5</a>
</li>
<li><a href="http://expressjs.com/en/guide/database-integration.html">Database integration</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<ul id="application-menu" class="menu dropit">
<li class="dropit-trigger"><a href="http://expressjs.com/en/4x/api.html">API reference</a>
<ul class="dropit-submenu" style="display: none;">
<li><a href="http://expressjs.com/en/5x/api.html">5.x (alpha)</a>
</li>
<li><a href="http://expressjs.com/en/4x/api.html">4.x</a>
</li>
<li><a href="http://expressjs.com/en/3x/api.html">3.x (deprecated)</a>
</li>
<li><a href="http://expressjs.com/2x/">2.x (deprecated)</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<ul id="advanced-topics-menu" class="menu dropit">
<li class="dropit-trigger"><a href="http://expressjs.com/en/advanced/developing-template-engines.html">Advanced topics</a>
<ul class="dropit-submenu" style="display: none;">
<li><a href="http://expressjs.com/en/advanced/developing-template-engines.html">Template engines</a>
</li>
<li><a href="http://expressjs.com/en/advanced/pm.html">Process managers</a>
</li>
<li><a href="http://expressjs.com/en/advanced/security-updates.html">Security updates</a>
</li>
<li><a href="http://expressjs.com/en/advanced/best-practice-security.html">Security best practices</a>
</li>
<li><a href="http://expressjs.com/en/advanced/best-practice-performance.html">Performance best practices</a>
</li>
<li><a href="http://expressjs.com/en/advanced/healthcheck-graceful-shutdown.html">Health checks and graceful shutdown</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="dropit-open">
<ul id="resources-menu" class="menu dropit">
<li class="dropit-trigger dropit-open"><a href="http://expressjs.com/en/resources/glossary.html" class="active">Resources</a>
<ul class="dropit-submenu" style="display: none;">
<li>
<a href="http://expressjs.com/en/resources/community.html">Community</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/glossary.html">Glossary</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/template-engines.html">Template Engines</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/middleware.html">Middleware</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/utils.html">Utility modules</a>
</li>
 <li>
<a href="http://expressjs.com/en/resources/frameworks.html">Frameworks</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/companies-using-express.html">Companies using Express</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/open-source-using-express.html">Open-source projects</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/learning.html">Additional learning</a>
</li>
<li>
<a href="http://expressjs.com/en/resources/contributing.html">Contributing to Express</a>
</li>
<li>
<a href="http://expressjs.com/en/changelog/4x.html">Release Change Log</a>
</li>
</ul>
</li>
</ul>
</li>

</ul>
</div>
</header>
<div id="overlay"></div>
<div id="page-doc" markdown="1">
<div id="mw-container">
<div id="mw-list">
<ul>
<li><a href="http://expressjs.com/resources/middleware/body-parser.html">body-parser</a></li>
<li><a href="http://expressjs.com/resources/middleware/compression.html">compression</a></li>
<li><a href="http://expressjs.com/resources/middleware/connect-rid.html">connect-rid</a></li>
<li><a href="http://expressjs.com/resources/middleware/cookie-parser.html">cookie-parser</a></li>
<li><a href="http://expressjs.com/resources/middleware/cookie-session.html">cookie-session</a></li>
<li><a href="http://expressjs.com/resources/middleware/cors.html">cors</a></li>
<li><a href="http://expressjs.com/resources/middleware/csurf.html">csurf</a></li>
<li><a href="http://expressjs.com/resources/middleware/errorhandler.html">errorhandler</a></li>
<li><a href="http://expressjs.com/resources/middleware/method-override.html">method-override</a></li>
<li><a href="http://expressjs.com/resources/middleware/morgan.html">morgan</a></li>
<li><a href="http://expressjs.com/resources/middleware/multer.html">multer</a></li>
<li><a href="http://expressjs.com/resources/middleware/response-time.html">response-time</a></li>
<li><a href="http://expressjs.com/resources/middleware/serve-favicon.html">serve-favicon</a></li>
<li><a href="http://expressjs.com/resources/middleware/serve-index.html">serve-index</a></li>
<li><a href="http://expressjs.com/resources/middleware/serve-static.html">serve-static</a></li>
<li><a href="http://expressjs.com/resources/middleware/session.html">session</a></li>
<li><a href="http://expressjs.com/resources/middleware/timeout.html">timeout</a></li>
<li><a href="http://expressjs.com/resources/middleware/vhost.html">vhost</a></li>
</ul>
</div>
<div id="middleware-content">
<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i>
<b>Note:</b> This page was generated from the
<a target="_blank" href="https://github.com/expressjs/csurf">csurf README</a>.
</div>
<h1 id="csurf">csurf</h1>
<p><a href="https://npmjs.org/package/csurf"><img src="Express%20csurf%20middleware_files/csurf.svg" alt="NPM Version"></a>
<a href="https://nodejs.org/en/download"><img src="Express%20csurf%20middleware_files/csurf_002.svg" alt="NPM Downloads"></a>
<a href="https://travis-ci.org/expressjs/csurf"><img src="Express%20csurf%20middleware_files/master.svg" alt="Build status"></a>
<a href="https://coveralls.io/r/expressjs/csurf?branch=master"><img src="Express%20csurf%20middleware_files/master_002.svg" alt="Test coverage"></a></p>
<p>Node.js <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a> protection middleware.</p>
<p>Requires either a session middleware or <a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a> to be initialized first.</p>
<ul>
<li>If you are setting the <a href="#cookie">“cookie” option</a> to a non-<code>false</code> value,
then you must use <a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a>
before this module.</li>
<li>Otherwise, you must use a session middleware before this module. For example:
<ul>
<li><a href="https://www.npmjs.com/package/express-session">express-session</a></li>
<li><a href="https://www.npmjs.com/package/cookie-session">cookie-session</a></li>
</ul>
</li>
</ul>
<p>If you have questions on how this module is implemented, please read
<a href="https://github.com/pillarjs/understanding-csrf">Understanding CSRF</a>.</p>
<h2 id="installation">Installation</h2>
<p>This is a <a href="https://nodejs.org/en/">Node.js</a> module available through the
<a href="https://www.npmjs.com/">npm registry</a>. Installation is done using the
<a href="https://docs.npmjs.com/getting-started/installing-npm-packages-locally"><code>npm install</code> command</a>:</p>
<pre class="language-sh"><code class="language-sh">$ npm install csurf
</code></pre>
<h2 id="api">API</h2>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> csurf <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'csurf'</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="csurfoptions">csurf([options])</h3>
<p>Create a middleware for CSRF token creation and validation. This middleware
adds a <code>req.csrfToken()</code> function to make a token which should be added to
requests which mutate state, within a hidden form field, query-string etc.
This token is validated against the visitor’s session or csrf cookie.</p>
<h4 id="options">Options</h4>
<p>The <code>csurf</code> function takes an optional <code>options</code> object that may contain
any of the following keys:</p>
<h5 id="cookie">cookie</h5>
<p>Determines if the token secret for the user should be stored in a cookie
or in <code>req.session</code>. Storing the token secret in a cookie implements
the <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie">double submit cookie pattern</a>.
Defaults to <code>false</code>.</p>
<p>When set to <code>true</code> (or an object of options for the cookie), then the module
changes behavior and no longer uses <code>req.session</code>. This means you <em>are no
longer required to use a session middleware</em>. Instead, you do need to use the
<a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a> middleware in
your app before this middleware.</p>
<p>When set to an object, cookie storage of the secret is enabled and the
object contains options for this functionality (when set to <code>true</code>, the
defaults for the options are used). The options may contain any of the
following keys:</p>
<ul>
<li><code>key</code> - the name of the cookie to use to store the token secret
(defaults to <code>'_csrf'</code>).</li>
<li><code>path</code> - the path of the cookie (defaults to <code>'/'</code>).</li>
<li><code>signed</code> - indicates if the cookie should be signed (defaults to <code>false</code>).</li>
<li><code>secure</code> - marks the cookie to be used with HTTPS only (defaults to
<code>false</code>).</li>
<li><code>maxAge</code> - the number of seconds after which the cookie will expire
(defaults to session length).</li>
<li><code>httpOnly</code> - flags the cookie to be accessible only by the web server
(defaults to <code>false</code>).</li>
<li><code>sameSite</code> - sets the same site policy for the cookie(defaults to
<code>false</code>). This can be set to <code>'strict'</code>, <code>'lax'</code>, <code>'none'</code>, or <code>true</code>
(which maps to <code>'strict'</code>).</li>
<li><code>domain</code> - sets the domain the cookie is valid on(defaults to current
domain).</li>
</ul>
<h5 id="ignoremethods">ignoreMethods</h5>
<p>An array of the methods for which CSRF token checking will disabled.
Defaults to <code>['GET', 'HEAD', 'OPTIONS']</code>.</p>
<h5 id="sessionkey">sessionKey</h5>
<p>Determines what property (“key”) on <code>req</code> the session object is located.
Defaults to <code>'session'</code> (i.e. looks at <code>req.session</code>). The CSRF secret
from this library is stored and read as <code>req[sessionKey].csrfSecret</code>.</p>
<p>If the <a href="#cookie">“cookie” option</a> is not <code>false</code>, then this option does
nothing.</p>
<h5 id="value">value</h5>
<p>Provide a function that the middleware will invoke to read the token from
the request for validation. The function is called as <code>value(req)</code> and is
expected to return the token as a string.</p>
<p>The default value is a function that reads the token from the following
locations, in order:</p>
<ul>
<li><code>req.body._csrf</code> - typically generated by the <code>body-parser</code> module.</li>
<li><code>req.query._csrf</code> - a built-in from Express.js to read from the URL
query string.</li>
<li><code>req.headers['csrf-token']</code> - the <code>CSRF-Token</code> HTTP request header.</li>
<li><code>req.headers['xsrf-token']</code> - the <code>XSRF-Token</code> HTTP request header.</li>
<li><code>req.headers['x-csrf-token']</code> - the <code>X-CSRF-Token</code> HTTP request header.</li>
<li><code>req.headers['x-xsrf-token']</code> - the <code>X-XSRF-Token</code> HTTP request header.</li>
</ul>
<h2 id="example">Example</h2>
<h3 id="simple-express-example">Simple express example</h3>
<p>The following is an example of some server-side code that generates a form
that requires a CSRF token to post back.</p>
<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> csrf <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'csurf'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'body-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// setup route middlewares
</span><span class="token keyword">var</span> csrfProtection <span class="token operator">=</span> <span class="token function">csrf<span class="token punctuation">(</span></span><span class="token punctuation">{</span> cookie<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> parseForm <span class="token operator">=</span> bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded<span class="token punctuation">(</span></span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token keyword">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// create express app
</span><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express<span class="token punctuation">(</span></span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// parse cookies
</span><span class="token comment" spellcheck="true">// we need this because "cookie" is true in csrfProtection
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">cookieParser<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/form'</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// pass the csrfToken to the view
</span>  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'send'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post<span class="token punctuation">(</span></span><span class="token string">'/process'</span><span class="token punctuation">,</span> parseForm<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'data is being processed'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Inside the view (depending on your template language; handlebars-style
is demonstrated here), set the <code>csrfToken</code> value as the value of a hidden
input field named <code>_csrf</code>:</p>
<pre><code class="language-html">&lt;form action="/process" method="POST"&gt;
  &lt;input type="hidden" name="_csrf" value=""&gt;
  
  Favorite color: &lt;input type="text" name="favoriteColor"&gt;
  &lt;button type="submit"&gt;Submit&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<h4 id="using-ajax">Using AJAX</h4>
<p>When accessing protected routes via ajax both the csrf token will need to be
passed in the request. Typically this is done using a request header, as adding
a request header can typically be done at a central location easily without
payload modification.</p>
<p>The CSRF token is obtained from the <code>req.csrfToken()</code> call on the server-side.
This token needs to be exposed to the client-side, typically by including it in
the initial page content. One possibility is to store it in an HTML <code>&lt;meta&gt;</code> tag,
where value can then be retrieved at the time of the request by JavaScript.</p>
<p>The following can be included in your view (handlebar example below), where the
<code>csrfToken</code> value came from <code>req.csrfToken()</code>:</p>
<pre><code class="language-html">&lt;meta name="csrf-token" content=""&gt;
</code></pre>
<p>The following is an example of using the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a> to post
to the <code>/process</code> route with the CSRF token from the <code>&lt;meta&gt;</code> tag on the page:</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token comment" spellcheck="true">// Read the CSRF token from the &lt;meta&gt; tag
</span><span class="token keyword">var</span> token <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector<span class="token punctuation">(</span></span><span class="token string">'meta[name="csrf-token"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute<span class="token punctuation">(</span></span><span class="token string">'content'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// Make a request using the Fetch API
</span><span class="token function">fetch<span class="token punctuation">(</span></span><span class="token string">'/process'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// &lt;-- includes cookies in the request
</span>  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'CSRF-Token'</span><span class="token punctuation">:</span> token <span class="token comment" spellcheck="true">// &lt;-- is the csrf token as a header
</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    favoriteColor<span class="token punctuation">:</span> <span class="token string">'blue'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="single-page-application-spa">Single Page Application (SPA)</h4>
<p>Many SPA frameworks like Angular have CSRF support built in automatically.
Typically they will reflect the value from a specific cookie, like
<code>XSRF-TOKEN</code> (which is the case for Angular).</p>
<p>To take advantage of this, set the value from <code>req.csrfToken()</code> in the cookie
used by the SPA framework. This is only necessary to do on the route that
renders the page (where <code>res.render</code> or <code>res.sendFile</code> is called in Express,
for example).</p>
<p>The following is an example for Express of a typical SPA response:</p>

<pre class="  language-javascript"><code class="  language-javascript">app<span class="token punctuation">.</span><span class="token function">all<span class="token punctuation">(</span></span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">cookie<span class="token punctuation">(</span></span><span class="token string">'XSRF-TOKEN'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">csrfToken<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'index'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="ignoring-routes">Ignoring Routes</h3>
<p><strong>Note</strong> CSRF checks should only be disabled for requests that you expect to
come from outside of your website. Do not disable CSRF checks for requests
that you expect to only come from your website. An existing session, even if
it belongs to an authenticated user, is not enough to protect against CSRF
attacks.</p>
<p>The following is an example of how to order your routes so that certain endpoints
do not check for a valid CSRF token.</p>
<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> csrf <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'csurf'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'body-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// create express app
</span><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express<span class="token punctuation">(</span></span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// create api router
</span><span class="token keyword">var</span> api <span class="token operator">=</span> <span class="token function">createApiRouter<span class="token punctuation">(</span></span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// mount api before csrf is appended to the app stack
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token string">'/api'</span><span class="token punctuation">,</span> api<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// now add csrf and other middlewares, after the "/api" was mounted
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded<span class="token punctuation">(</span></span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token keyword">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">cookieParser<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">csrf<span class="token punctuation">(</span></span><span class="token punctuation">{</span> cookie<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/form'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// pass the csrfToken to the view
</span>  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'send'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post<span class="token punctuation">(</span></span><span class="token string">'/process'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'csrf was required to get here'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> createApiRouter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">express<span class="token punctuation">.</span>Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  router<span class="token punctuation">.</span><span class="token function">post<span class="token punctuation">(</span></span><span class="token string">'/getProfile'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'no csrf to get here'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> router
<span class="token punctuation">}</span>
</code></pre>
<h3 id="custom-error-handling">Custom error handling</h3>
<p>When the CSRF token validation fails, an error is thrown that has
<code>err.code === 'EBADCSRFTOKEN'</code>. This can be used to display custom
error messages.</p>
<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'body-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> csrf <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'csurf'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded<span class="token punctuation">(</span></span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token keyword">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">cookieParser<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">csrf<span class="token punctuation">(</span></span><span class="token punctuation">{</span> cookie<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// error handler
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">!</span><span class="token operator">==</span> <span class="token string">'EBADCSRFTOKEN'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// handle CSRF token errors here
</span>  res<span class="token punctuation">.</span><span class="token function">status<span class="token punctuation">(</span></span><span class="token number">403</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'form tampered with'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="references">References</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">Cross-side request forgery on Wikipedia</a></li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">OWASP Cross-Site Request Forgery Prevention Cheat Sheet</a></li>
</ul>
<h2 id="license">License</h2>
<p><a href="http://expressjs.com/en/resources/middleware/LICENSE">MIT</a></p>
</div>
</div>
</div>
</section>
<a id="top" href="#"><img src="Express%20csurf%20middleware_files/arrow.png"></a>
<footer>
<section id="doc-langs">
Documentation translations provided by <a href="http://strongloop.com/">StrongLoop/IBM</a>:
<a href="http://expressjs.com/fr/">French</a>, <a href="http://expressjs.com/de/">German</a>, <a href="http://expressjs.com/es/">Spanish</a>, <a href="http://expressjs.com/it/">Italian</a>, <a href="http://expressjs.com/ja/">Japanese</a>, <a href="http://expressjs.com/ru/">Russian</a>, <a href="http://expressjs.com/zh-cn/">Chinese</a>, <a href="http://expressjs.com/zh-tw/">Traditional Chinese</a>, <a href="http://expressjs.com/ko/">Korean</a>, <a href="http://expressjs.com/pt-br/">Portuguese</a>.
<br>
Community translation available for: <a href="http://expressjs.com/sk/">Slovak</a>, <a href="http://expressjs.com/uk/">Ukrainian</a>, <a href="http://expressjs.com/uz/">Uzbek</a>, <a href="http://expressjs.com/tr/">Turkish</a> and <a href="http://expressjs.com/th/">Thai</a>.
</section>
<div id="footer-content">
<div id="github">
<span></span>
</div>
<div id="sponsor"><a href="https://expressjs.com/">Express</a> is a project of the <a href="https://openjsf.org/">OpenJS Foundation</a>.</div>
<div id="fork"><a href="https://github.com/expressjs/expressjs.com/blob/gh-pages/en/resources/middleware/csurf.md">Edit this page on GitHub</a>.</div>
<div>Copyright © 2017 StrongLoop, IBM, and other expressjs.com contributors.</div>
</div>
<div id="license">
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative Commons License" style="border-width:0" src="Express%20csurf%20middleware_files/80x15.png"></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-ShareAlike 3.0 United States License</a>.
</div>
</footer>
<script async="" defer="defer" src="Express%20csurf%20middleware_files/buttons.js" type="text/javascript"></script>
<script async="" type="text/javascript" src="Express%20csurf%20middleware_files/docsearch.js" onload="docsearch({
  apiKey: '7164e33055faa6ecddefd9e08fc59f5d',
  indexName: 'expressjs',
  inputSelector: '#q',
  algoliaOptions: { 'facetFilters': ['lang:en'] }
})"></script>


</body></html>